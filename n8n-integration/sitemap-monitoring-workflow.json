{
  "name": "Sitemap监控-统一工作流",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "value": "0 */2 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.cron",
      "position": [240, 300],
      "name": "每2小时触发"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "sheet",
        "operation": "read",
        "documentId": "YOUR_GOOGLE_SHEET_ID",
        "sheetName": "sitemap-config",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "position": [460, 300],
      "name": "读取Sheet配置"
    },
    {
      "parameters": {
        "url": "=https://YOUR_WORKER_DOMAIN.workers.dev/api/status",
        "authentication": "none",
        "requestMethod": "GET",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [680, 300],
      "name": "获取Worker当前配置"
    },
    {
      "parameters": {
        "jsCode": "// 对比Sheet配置与Worker配置，找出差异\nconst sheetData = $node[\"读取Sheet配置\"].json;\nconst workerData = $node[\"获取Worker当前配置\"].json;\n\n// 获取Sheet中的活跃网站\nconst sheetUrls = sheetData\n  .filter(item => item.status === 'active')\n  .map(item => item.sitemap_url);\n\n// 获取Worker中当前监控的网站\nconst workerUrls = workerData.feeds || [];\n\n// 找出需要添加和删除的网站\nconst toAdd = sheetUrls.filter(url => !workerUrls.includes(url));\nconst toRemove = workerUrls.filter(url => !sheetUrls.includes(url));\n\n// 创建同步任务\nconst syncTasks = [];\n\n// 添加新网站\ntoAdd.forEach(url => {\n  const siteInfo = sheetData.find(item => item.sitemap_url === url);\n  syncTasks.push({\n    action: 'add',\n    url: url,\n    website_name: siteInfo.website_name,\n    notes: siteInfo.notes\n  });\n});\n\n// 删除网站\ntoRemove.forEach(url => {\n  syncTasks.push({\n    action: 'remove',\n    url: url,\n    website_name: 'Unknown',\n    notes: 'Removed from monitoring'\n  });\n});\n\nconst result = {\n  sync_needed: syncTasks.length > 0,\n  sync_tasks: syncTasks,\n  total_active_sites: sheetUrls.length,\n  sites_to_add: toAdd.length,\n  sites_to_remove: toRemove.length,\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('配置同步分析:', result);\n\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "position": [900, 300],
      "name": "分析配置差异"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.sync_needed }}",
              "operation": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "position": [1120, 300],
      "name": "检查是否需要同步"
    },
    {
      "parameters": {
        "jsCode": "// 展开同步任务为单独的项目\nconst syncData = $input.first().json;\nconst tasks = syncData.sync_tasks;\n\nreturn tasks.map(task => ({\n  ...task,\n  timestamp: syncData.timestamp\n}));"
      },
      "type": "n8n-nodes-base.code",
      "position": [1340, 240],
      "name": "展开同步任务"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "operation": "equal",
              "value2": "add"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "position": [1560, 200],
      "name": "分离添加任务"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "operation": "equal",
              "value2": "remove"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "position": [1560, 280],
      "name": "分离删除任务"
    },
    {
      "parameters": {
        "url": "=https://YOUR_WORKER_DOMAIN.workers.dev/api/feeds/add",
        "authentication": "none",
        "requestMethod": "POST",
        "jsonParameters": true,
        "parametersJson": "={\n  \"url\": \"{{ $json.url }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [1780, 160],
      "name": "添加网站到监控"
    },
    {
      "parameters": {
        "url": "=https://YOUR_WORKER_DOMAIN.workers.dev/api/feeds/remove",
        "authentication": "none",
        "requestMethod": "POST",
        "jsonParameters": true,
        "parametersJson": "={\n  \"url\": \"{{ $json.url }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [1780, 280],
      "name": "从监控中删除网站"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "position": [2000, 220],
      "name": "合并同步结果"
    },
    {
      "parameters": {
        "jsCode": "// 处理同步结果\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  results.push({\n    sync_completed: true,\n    action: data.action || 'unknown',\n    url: data.url || 'unknown',\n    success: data.status === 'success',\n    message: data.message || 'Sync completed',\n    timestamp: new Date().toISOString()\n  });\n}\n\n// 如果没有同步任务，创建一个跳过记录\nif (results.length === 0) {\n  results.push({\n    sync_completed: true,\n    action: 'skip',\n    url: 'none',\n    success: true,\n    message: 'No sync needed, configurations are up to date',\n    timestamp: new Date().toISOString()\n  });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "position": [1340, 360],
      "name": "处理跳过同步"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "position": [2220, 300],
      "name": "合并所有同步结果"
    },
    {
      "parameters": {
        "url": "=https://YOUR_WORKER_DOMAIN.workers.dev/monitor",
        "authentication": "none",
        "requestMethod": "POST",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [2440, 300],
      "name": "执行监控任务"
    },
    {
      "parameters": {
        "jsCode": "// 处理监控结果\nconst monitorResult = $input.first().json;\nconst timestamp = new Date().toISOString();\n\n// 创建监控记录\nconst result = {\n  timestamp: timestamp,\n  monitoring_completed: true,\n  worker_status: monitorResult.status || 'unknown',\n  worker_message: monitorResult.message || 'Monitoring completed',\n  success: monitorResult.status === 'success',\n  raw_response: JSON.stringify(monitorResult)\n};\n\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "position": [2660, 300],
      "name": "处理监控结果"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "sheet",
        "operation": "append",
        "documentId": "YOUR_GOOGLE_SHEET_ID",
        "sheetName": "monitoring-logs",
        "options": {
          "cellFormat": "USER_ENTERED"
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "position": [2880, 240],
      "name": "保存监控日志"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "sheet",
        "operation": "update",
        "documentId": "YOUR_GOOGLE_SHEET_ID",
        "sheetName": "sitemap-config",
        "columnToMatchOn": "status",
        "valueToMatchOn": "active",
        "options": {
          "cellFormat": "USER_ENTERED"
        },
        "dataToUpdate": {
          "metaData": {
            "columns": [
              {
                "column": "last_check",
                "value": "={{ $json.timestamp }}"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "position": [2880, 360],
      "name": "更新检查时间"
    },
    {
      "parameters": {
        "url": "=https://YOUR_WORKER_DOMAIN.workers.dev/test/simple",
        "authentication": "none",
        "requestMethod": "POST",
        "jsonParameters": true,
        "parametersJson": "={\n  \"message\": \"📊 n8n统一监控完成\\n时间: {{ $json.timestamp }}\\n状态: {{ $json.worker_status }}\\n消息: {{ $json.worker_message }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [3100, 300],
      "name": "发送完成通知"
    }
  ],
  "connections": {
    "每2小时触发": {
      "main": [
        [
          {
            "node": "读取Sheet配置",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取Sheet配置": {
      "main": [
        [
          {
            "node": "获取Worker当前配置",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "获取Worker当前配置": {
      "main": [
        [
          {
            "node": "分析配置差异",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "分析配置差异": {
      "main": [
        [
          {
            "node": "检查是否需要同步",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "检查是否需要同步": {
      "main": [
        [
          {
            "node": "展开同步任务",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "处理跳过同步",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "展开同步任务": {
      "main": [
        [
          {
            "node": "分离添加任务",
            "type": "main",
            "index": 0
          },
          {
            "node": "分离删除任务",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "分离添加任务": {
      "main": [
        [
          {
            "node": "添加网站到监控",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "分离删除任务": {
      "main": [
        [
          {
            "node": "从监控中删除网站",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "添加网站到监控": {
      "main": [
        [
          {
            "node": "合并同步结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "从监控中删除网站": {
      "main": [
        [
          {
            "node": "合并同步结果",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "合并同步结果": {
      "main": [
        [
          {
            "node": "合并所有同步结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理跳过同步": {
      "main": [
        [
          {
            "node": "合并所有同步结果",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "合并所有同步结果": {
      "main": [
        [
          {
            "node": "执行监控任务",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "执行监控任务": {
      "main": [
        [
          {
            "node": "处理监控结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理监控结果": {
      "main": [
        [
          {
            "node": "保存监控日志",
            "type": "main",
            "index": 0
          },
          {
            "node": "更新检查时间",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "保存监控日志": {
      "main": [
        [
          {
            "node": "发送完成通知",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "saveDataSuccessExecution": "none",
    "saveDataErrorExecution": "all",
    "saveDataProgressExecution": false,
    "executionTimeout": 3600,
    "saveDataManualExecution": true
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-07-04T10:00:00.000Z",
      "updatedAt": "2025-07-04T10:00:00.000Z",
      "id": "unified",
      "name": "sitemap-monitoring"
    }
  ]
}